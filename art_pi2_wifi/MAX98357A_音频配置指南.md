# MAX98357A 音频配置指南

## 📋 硬件清单

- ✅ ART-Pi2 开发板
- ✅ MAX98357A 功放模块
- ✅ 4Ω 3W 喇叭
- ✅ 杜邦线若干

## 🔌 硬件连接

### 接线图

```
ART-Pi2                MAX98357A                 喇叭
┌────────┐            ┌──────────┐             ┌──────┐
│        │            │          │             │      │
│  5V    ├───────────►│ VIN      │             │      │
│  GND   ├───────────►│ GND      │             │      │
│        │            │          │             │      │
│ PB9    ├───────────►│ LRC      │             │      │
│ (WS)   │            │          │             │      │
│        │            │          │             │      │
│ PB10   ├───────────►│ BCLK     │             │      │
│ (SCK)  │            │          │             │      │
│        │            │          │   OUT+  ────┼───►  │
│ PB15   ├───────────►│ DIN      │             │  +   │
│ (SD)   │            │          │   OUT-  ────┼───►  │
│        │            │          │             │  -   │
│ 3.3V   ├───────────►│ SD       │             │      │
│        │            │ (Enable) │             │      │
│        │            │          │             │      │
│        │            │ GAIN ────┤GND          └──────┘
└────────┘            └──────────┘  (9dB增益)
```

### 详细接线表

| 序号 | ART-Pi2 | MAX98357A | 线色建议 | 说明 |
|------|---------|-----------|----------|------|
| 1 | **5V** | VIN | 红色 | 电源（更大音量）|
| 2 | **GND** | GND | 黑色 | 公共地 |
| 3 | **PB9** | LRC | 黄色 | I2S 字选择 |
| 4 | **PB10** | BCLK | 绿色 | I2S 位时钟 |
| 5 | **PB15** | DIN | 蓝色 | I2S 数据 |
| 6 | **3.3V** | SD | 橙色 | 芯片使能 |
| 7 | - | GAIN | 接GND | 9dB 增益 |
| 8 | 喇叭+ | OUT+ | - | 喇叭正极 |
| 9 | 喇叭- | OUT- | - | 喇叭负极 |

### ⚠️ 注意事项

1. **电源选择**：
   - 使用 **5V** 供电：最大功率 3.2W@4Ω，音量更大 ✅
   - 使用 3.3V 供电：功率约 1.4W@4Ω，音量较小

2. **增益设置**（GAIN 引脚）：
   - 接 **GND**：9dB 增益（推荐）
   - **悬空**：15dB 增益（可能失真）
   - 接 **3.3V**：3dB 增益（音量小）

3. **喇叭极性**：
   - 确保正负极正确，否则会影响音质
   - 可以先试连接，如果音量小可对调

## 💻 软件配置

### 步骤1：CubeMX 配置 I2S

1. **打开 CubeMX 工程**
   ```
   board/CubeMX_Config/CubeMX_Config.ioc
   ```

2. **配置 SPI2 为 I2S 模式**
   - 找到 **Connectivity** → **SPI2**
   - Mode: **Half-Duplex Master Transmit Only**
   - Hardware NSS Signal: **Disable**

3. **配置 I2S 参数**
   ```
   Mode: Master Transmit
   Communication Standard: I2S Philips
   Data and Frame Format: 16 Bits Data on 16 Bits Frame
   Selected Audio Frequency: 16 KHz
   Clock Polarity: Low
   Master Clock Output: Disable (MAX98357A不需要MCLK)
   ```

4. **配置 DMA**
   - 添加 **SPI2_TX** DMA 请求
   - Mode: Normal
   - Priority: High
   - Data Width: Half Word

5. **确认引脚映射**
   ```
   PB9  → I2S2_WS
   PB10 → I2S2_CK
   PB15 → I2S2_SD
   ```

6. **生成代码**
   - Project Manager → Generate Code

### 步骤2：添加驱动文件

将以下文件添加到项目：

```
applications/
├── drv_audio_max98357a.c    # I2S 音频驱动
├── drv_audio_max98357a.h    # 驱动头文件
├── audio_player_i2s.c       # 音频播放器（I2S版本）
└── audio_test.c             # 测试程序
```

### 步骤3：修改编译配置

在 `applications/SConscript` 中添加：

```python
src += ['drv_audio_max98357a.c']
src += ['audio_test.c']

# 如果要替换原有的 audio_player，则：
# src += ['audio_player_i2s.c']  # 新版本
# 注释掉旧的：
# src += ['audio_player.c']       # 旧版本
```

### 步骤4：使能 Audio 框架

在 `rtconfig.h` 中确保开启：

```c
#define RT_USING_AUDIO
#define RT_AUDIO_REPLAY_MP_BLOCK_SIZE   2048
#define RT_AUDIO_REPLAY_MP_BLOCK_COUNT  2
```

## 🚀 编译和测试

### 1. 编译固件

```bash
scons -j8
```

### 2. 下载固件

使用 RT-Thread Studio 或 ST-Link 下载

### 3. 测试音频

#### 测试1：设备检测

```bash
msh> list_device

# 应该看到：
audio0       Audio Device
```

#### 测试2：正弦波测试

```bash
msh> audio_test

# 输出：
[I/audio.test] MAX98357A Audio Test
[I/audio.test] Generating 440Hz sine wave, 1000ms
[I/audio.test] Playing audio...
[I/audio.test] Audio test completed successfully!
[I/audio.test] You should hear a 440Hz tone from the speaker
```

**期望效果**：喇叭发出 1 秒钟的 440Hz 音调（钢琴 A4 音）

#### 测试3：嘀嘀声测试

```bash
msh> audio_beep
Beep 1000Hz

# 指定频率
msh> audio_beep 2000
Beep 2000Hz
```

## 🔧 故障排除

### 问题1：没有声音

**检查清单：**
1. ✅ 硬件连接是否正确
2. ✅ 电源是否正常（5V 或 3.3V）
3. ✅ SD 引脚是否连接到 3.3V（使能芯片）
4. ✅ 喇叭是否良好
5. ✅ `list_device` 能否看到 audio0

**调试方法：**
```bash
# 查看设备
msh> list_device

# 查看 I2S 寄存器（如果有调试工具）
# 用示波器检查 BCLK、LRC、DIN 信号
```

### 问题2：音量太小

**解决方案：**
1. 使用 **5V** 供电代替 3.3V
2. 将 GAIN 引脚**悬空**（15dB 增益）
3. 检查喇叭阻抗（应为 4Ω 或 8Ω）

### 问题3：声音失真

**解决方案：**
1. GAIN 引脚连接到 **GND**（降低增益到 9dB）
2. 降低音频数据的幅度（代码中减小 volume）
3. 检查电源是否稳定

### 问题4：编译错误

**常见错误：**
```
undefined reference to `HAL_I2S_Transmit_DMA'
```

**解决**：
- 确认 CubeMX 已配置 I2S 和 DMA
- 重新生成代码
- 确认 HAL_I2S_MODULE_ENABLED 已定义

### 问题5：DMA 传输失败

**检查：**
1. DMA 中断是否使能
2. `HAL_I2S_TxCpltCallback` 是否被调用
3. 检查 DMA 优先级设置

## 📊 性能参数

| 参数 | 值 |
|------|-----|
| 采样率 | 8K/16K/22K/44.1K/48K Hz |
| 位深度 | 16 bit |
| 声道 | 单声道（Mono）|
| 最大功率 | 3.2W @ 4Ω @ 5V |
| 失真度 | < 1% THD+N |
| 延迟 | < 10ms |
| RAM 占用 | ~4KB |

## 🎵 音频格式支持

当前支持：
- ✅ PCM 16bit 单声道
- ✅ 采样率：8K/16K/22K/44.1K/48K Hz

未来计划：
- ⏳ MP3 解码
- ⏳ WAV 文件播放
- ⏳ TTS 语音合成
- ⏳ 立体声支持

## 💡 应用示例

### 示例1：播放提示音

```c
#include "audio_player.h"

void play_notification(void)
{
    int16_t beep[160];  // 10ms @ 16kHz
    
    // 生成 1kHz 嘀声
    for (int i = 0; i < 160; i++)
    {
        beep[i] = (int16_t)(sin(2 * M_PI * 1000 * i / 16000) * 10000);
    }
    
    // 播放
    audio_player_play((uint8_t *)beep, sizeof(beep));
}
```

### 示例2：语音合成播放

```c
// AI 回复转语音后播放
void play_ai_reply(const char *text)
{
    ai_response_t tts_resp;
    
    // TTS 转换
    ai_cloud_service_text_to_speech(text, &tts_resp);
    
    // 播放语音
    if (tts_resp.audio_result && tts_resp.audio_len > 0)
    {
        audio_player_play((uint8_t *)tts_resp.audio_result, 
                         tts_resp.audio_len);
    }
    
    ai_cloud_service_free_response(&tts_resp);
}
```

## 📚 参考资料

- [MAX98357A 数据手册](https://www.analog.com/media/en/technical-documentation/data-sheets/MAX98357A-MAX98357B.pdf)
- [STM32H7 I2S 应用笔记](https://www.st.com/resource/en/application_note/an5027-stm32-crossseries-timer-overview.pdf)
- [RT-Thread Audio 框架文档](https://www.rt-thread.org/document/site/programming-manual/device/audio/audio/)

## 🎉 完成

恭喜！你已经成功配置了 MAX98357A 音频输出！

现在可以：
- ✅ 播放测试音
- ✅ 播放 AI 语音回复
- ✅ 播放提示音和警告音

**下一步：集成 TTS 服务，让 AI 回复变成语音！** 🎤

